# Implementation Plan: Context Architecture Optimization (Protocol Partitioning)

> Generated by `/PACT:plan-mode` on 2026-01-15
> Status: PENDING APPROVAL
> **Last Updated**: 2026-01-15 (Second peer review feedback incorporated â€” agent files scope added)

<!-- Status Lifecycle:
     PENDING APPROVAL â†’ APPROVED â†’ IN_PROGRESS â†’ IMPLEMENTED
                    â†˜ SUPERSEDED (if replaced by newer plan)
                    â†˜ BLOCKED (if unresolved conflicts)

     Transition Ownership:
     - PENDING APPROVAL â†’ APPROVED: User (explicit approval)
     - APPROVED â†’ IN_PROGRESS: Orchestrator (when /PACT:orchestrate starts)
     - IN_PROGRESS â†’ IMPLEMENTED: Orchestrator (after successful completion)
     - Any â†’ SUPERSEDED: plan-mode (when creating replacement plan)
     - Any â†’ BLOCKED: plan-mode (when unresolved blocking conflicts)
-->

## Summary

Optimize PACT framework context loading by:
1. **Compressing CLAUDE.md** from 306 lines to ~100-110 lines (preserving phase principles)
2. **Partitioning pact-protocols.md** (1,085 lines) into 8 focused protocol files
3. **Updating commands** to @-reference only the specific protocols they need
4. **Updating agent files** (7 specialists) with targeted @-refs to new protocol files

**Why protocol partitioning over skills**: PACT is a deterministic, structured workflow where we know exactly when each protocol is needed. Explicit @-references provide predictable, controlled loading that aligns with PACT's structured nature. Skills (auto-discovery) are better suited for optional, contextual guidance.

**Framework-wide impact**: All 8 PACT commands benefit. The heaviest commands (`orchestrate`, `plan-mode`) see ~55% reductions. All commands benefit from 67% smaller CLAUDE.md. Expected savings: ~55% reduction in typical orchestration context load.

**Supersedes**:
- PR #68 draft plan
- `context-architecture-skills-plan.md` (skills approach reconsidered)

---

## Specialist Perspectives

### ðŸ“‹ Preparation Phase
**Effort**: Low-Medium

#### Research Completed
- [x] Anthropic context engineering guidance reviewed ([source](https://www.anthropic.com/research/building-effective-agents))
- [x] CLAUDE.md size guidelines established (working assumption: < 60 lines ideal, < 300 max â€” derived from context engineering principles, not explicit Anthropic documentation)
- [x] Current context load measured (CLAUDE.md ~4K, pact-protocols.md ~10K tokens; estimated via ~10 tokens/line approximation)
- [x] Skills vs @-references trade-offs analyzed
- [x] PACT workflow determinism assessed (favors explicit references)
- [x] Agent files audited for protocol references (**21 refs found across 7 files** â€” require updates)
- [x] rePACT.md dependencies verified (self-contained, no @-refs needed)

#### Questions Resolved
- **Skills vs Protocols**: Protocol partitioning preferred for PACT's deterministic workflows
- **Algedonic location**: Keep separate algedonic.md file (already concise, safety-critical)
- **VSM distribution**: Keep vsm-glossary.md as central reference
- **rePACT dependencies**: Command has conceptual references ("see Autonomy Charter", "Apply S2 coordination") but these are inline explanatory text, NOT @-file references. No changes needed.
- **Agent file dependencies**: All 7 specialist agent files contain @-refs to `pact-protocols.md` for workflow handoffs and S1 Autonomy. These require targeted updates after partitioning.

---

### ðŸ—ï¸ Architecture Phase
**Effort**: Medium

#### Components Affected
| Component | Change Type | Impact |
|-----------|-------------|--------|
| `CLAUDE.md` | Compress | 306 â†’ ~100-110 lines |
| `protocols/pact-protocols.md` | Partition | 1,085 â†’ ~180 lines (lean index) |
| `protocols/delegation.md` | New | ~145 lines |
| `protocols/s4-checkpoints.md` | New | ~140 lines |
| `protocols/variety-management.md` | New | ~60 lines |
| `protocols/s2-coordination.md` | New | ~110 lines |
| `protocols/s3-audit.md` | New | ~60 lines |
| `protocols/s3s4-tension.md` | New | ~65 lines |
| `protocols/workflow-protocols.md` | New | ~105 lines |
| `protocols/phase-guidance.md` | New | ~100 lines |
| `commands/PACT/orchestrate.md` | Modify | Replace monolithic @-ref with targeted @-refs |
| `commands/PACT/plan-mode.md` | Modify | Replace monolithic @-ref with targeted @-refs |
| `agents/pact-*.md` (7 files) | Modify | Update @pact-protocols refs to targeted protocol files |

#### Design Approach

**Protocol Partitioning Architecture**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CLAUDE.md (~100-110 lines)               â”‚
â”‚  Always loaded: Mission, S5 Policy, Phase Principles,       â”‚
â”‚                 Specialist list, Command list               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Commands @-reference only what they need
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Partitioned Protocol Files                 â”‚
â”‚                                                             â”‚
â”‚  pact-protocols.md (~180 lines)                             â”‚
â”‚  â””â”€ Lean index + S1 Autonomy + Cross-Cutting Concerns       â”‚
â”‚                                                             â”‚
â”‚  delegation.md (~145 lines)                                 â”‚
â”‚  â””â”€ S5 Policy, Tool checkpoint, app code definition         â”‚
â”‚                                                             â”‚
â”‚  s4-checkpoints.md (~140 lines)                             â”‚
â”‚  â””â”€ S4 checkpoint protocol, environment model               â”‚
â”‚                                                             â”‚
â”‚  variety-management.md (~60 lines)                          â”‚
â”‚  â””â”€ Variety scoring, workflow selection, strategies         â”‚
â”‚                                                             â”‚
â”‚  s2-coordination.md (~110 lines)                            â”‚
â”‚  â””â”€ Pre-parallel checks, conflict resolution                â”‚
â”‚                                                             â”‚
â”‚  s3-audit.md (~60 lines)                                    â”‚
â”‚  â””â”€ Continuous audit, RED/YELLOW/GREEN signals              â”‚
â”‚                                                             â”‚
â”‚  s3s4-tension.md (~65 lines)                                â”‚
â”‚  â””â”€ Tension detection, resolution protocol                  â”‚
â”‚                                                             â”‚
â”‚  workflow-protocols.md (~105 lines)                         â”‚
â”‚  â””â”€ plan-mode, imPACT, comPACT protocol summaries           â”‚
â”‚                                                             â”‚
â”‚  phase-guidance.md (~100 lines)                             â”‚
â”‚  â””â”€ Test Engagement, Phase Handoffs, Backend/DB Boundary    â”‚
â”‚                                                             â”‚
â”‚  algedonic.md (~235 lines) â€” unchanged                      â”‚
â”‚  â””â”€ Emergency bypass, HALT/ALERT signals                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Commands load only relevant protocols
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  orchestrate.md                                             â”‚
â”‚  â””â”€ @delegation, @variety-management, @s4-checkpoints,      â”‚
â”‚     @s2-coordination, @s3-audit, @phase-guidance, @algedonicâ”‚
â”‚                                                             â”‚
â”‚  plan-mode.md                                               â”‚
â”‚  â””â”€ @variety-management, @workflow-protocols                â”‚
â”‚                                                             â”‚
â”‚  imPACT.md                                                  â”‚
â”‚  â””â”€ @algedonic, @workflow-protocols                         â”‚
â”‚                                                             â”‚
â”‚  comPACT.md                                                 â”‚
â”‚  â””â”€ @workflow-protocols (optional, for protocol reference)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Key Decisions
| Decision | Options | Recommendation | Rationale |
|----------|---------|----------------|-----------|
| Approach | Skills (auto-discovery) vs Protocols (@-refs) | Protocol partitioning | PACT is deterministic; explicit control preferred |
| Protocol count | 6 files vs 8 files | 8 focused files | Complete content accounting shows 8 needed for target index size |
| CLAUDE.md size | ~85 vs ~100-110 lines | ~100-110 lines | Preserves phase principles that guide behavior |
| pact-protocols.md | ~100 vs ~180 lines | ~180 lines (lean index) | Realistic after complete content accounting |
| Algedonic | Partition vs keep whole | Keep whole | Safety-critical, already concise, well-isolated |

#### Interface Contracts

**Targeted @-Reference Pattern**:

```markdown
# Current (loads entire 1,085-line file every time):
See @~/.claude/protocols/pact-protocols.md for S4 Checkpoint Protocol.

# New (loads only ~140-line file when needed):
See @~/.claude/protocols/s4-checkpoints.md for the checkpoint protocol.
```

**Protocol File Mapping** (what each command needs):

| Command | Protocols Needed |
|---------|------------------|
| `orchestrate.md` | delegation, variety-management, s4-checkpoints, s2-coordination, s3-audit, phase-guidance, algedonic |
| `plan-mode.md` | variety-management, workflow-protocols |
| `imPACT.md` | algedonic, workflow-protocols |
| `comPACT.md` | workflow-protocols (optional) |
| `rePACT.md` | None (self-contained with inline guidance) |

**Estimated Load per Command**:

| Command | Current @-refs Load | New @-refs Load | Reduction |
|---------|---------------------|-----------------|-----------|
| orchestrate | ~1,320 lines | ~715 lines | **46%** |
| plan-mode | ~1,085 lines | ~165 lines | **85%** |
| imPACT | ~235 lines | ~340 lines | -45% (adds workflow-protocols for context) |

---

### ðŸ’» Code Phase
**Effort**: Medium

> **Note**: This is AI tooling (.claude/ files), not application code. Per delegation rules, the orchestrator may implement these changes directly. No specialist delegation required.

#### Complete Content Accounting

Every section of `pact-protocols.md` (1,085 lines) is mapped to its destination:

| Source Section | Lines | Destination | Notes |
|----------------|-------|-------------|-------|
| Header + VSM Quick Reference | 1-10 | `pact-protocols.md` (index) | Keep as intro |
| S5 Policy Layer (Governance) | 13-145 | `delegation.md` | Includes Non-Negotiables, Delegation Enforcement, Policy Checkpoints, S5 Authority, S5 Decision Framing |
| S4 Checkpoint Protocol | 148-217 | `s4-checkpoints.md` | Includes Trigger Points, Questions, Outcomes, Format |
| S4 Environment Model | 220-291 | `s4-checkpoints.md` | Combined with S4 Checkpoint |
| S3/S4 Tension Detection | 294-356 | `s3s4-tension.md` | Includes Indicators, Detection Phrases, Resolution |
| S2 Coordination Layer | 359-465 | `s2-coordination.md` | Includes Pre-Parallel Check, Conflict Resolution, Anti-Oscillation |
| S1 Autonomy & Recursion | 468-540 | `pact-protocols.md` (index) | Keep inline (~72 lines) - referenced by multiple protocols |
| S3* Continuous Audit | 543-601 | `s3-audit.md` | Includes Audit Modes, Signals, S2 Coordination |
| Algedonic Signals | 604-644 | `algedonic.md` | Already separate (~40 line summary here, full file exists) |
| Variety Management | 647-706 | `variety-management.md` | Includes Dimensions, Score, Strategies |
| PACT Workflow Family | 709-718 | `pact-protocols.md` (index) | Keep inline (~9 lines) - overview table |
| plan-mode Protocol | 721-754 | `workflow-protocols.md` | Protocol summary |
| imPACT Protocol | 757-773 | `workflow-protocols.md` | Protocol summary |
| comPACT Protocol | 776-832 | `workflow-protocols.md` | Protocol summary |
| Phase Handoffs | 835-842 | `phase-guidance.md` | Universal guidance |
| Backend â†” Database Boundary | 846-858 | `phase-guidance.md` | Specialist coordination |
| Test Engagement | 861-941 | `phase-guidance.md` | CODEâ†’TEST handoff |
| Cross-Cutting Concerns | 945-954 | `pact-protocols.md` (index) | Keep inline (~9 lines) - brief checklist |
| Architecture Review | 957-963 | `pact-protocols.md` (index) | Keep inline (~6 lines) - brief |
| Documentation Locations | 967-1069 | `pact-protocols.md` (index) | Keep inline (~102 lines) - reference table |
| Session Continuity | 1073-1079 | `pact-protocols.md` (index) | Keep inline (~6 lines) |
| Related | 1082-1086 | `pact-protocols.md` (index) | Keep inline (~4 lines) |

**Summary**:
- Content partitioned to new files: ~785 lines (8 files)
- Content remaining in index: ~180 lines
- Content in separate algedonic.md: ~235 lines (unchanged)
- Total accounted: 1,085 lines âœ“

#### Cross-Reference Inventory

Internal references within `pact-protocols.md` that need updating after partitioning:

| Location | Current Reference | New Reference | Notes |
|----------|-------------------|---------------|-------|
| Line 7 | `@~/.claude/reference/vsm-glossary.md` | Keep as-is | External reference |
| Line 212 | "see Variety Management" | `@variety-management.md` | Cross-protocol ref |
| Line 349-355 | S3/S4 tension refs S4 Checkpoints | `@s4-checkpoints.md` | Cross-protocol ref |
| Line 435-436 | "see CODE â†’ TEST Handoff", "see Phase Handoffs" | `@phase-guidance.md` | Cross-protocol ref |
| Line 488 | "see S2 Coordination" | `@s2-coordination.md` | Cross-protocol ref |
| Line 539 | `@~/.claude/commands/PACT/rePACT.md` | Keep as-is | External reference |
| Line 586 | "unlike algedonic signalsâ€”see below" | `@algedonic.md` | Cross-protocol ref |
| Line 610 | `@~/.claude/protocols/algedonic.md` | Keep as-is | External reference |
| Line 694 | "/PACT:rePACT" | Keep as-is | Command reference |
| Line 696 | "S3*" reference | `@s3-audit.md` | Cross-protocol ref |
| Line 969 | "filesystem-context" skill | Keep as-is | External reference |

**Total internal cross-references requiring updates**: 7

#### Agent Files Cross-Reference Inventory

All 7 specialist agent files reference `pact-protocols.md`. After partitioning, these need targeted updates:

| Agent File | Reference Purpose | Current @-ref | New @-ref |
|------------|-------------------|---------------|-----------|
| `pact-architect.md` | Cross-Agent Coordination | `@pact-protocols.md` | `@phase-guidance.md` |
| `pact-architect.md` | S1 Autonomy & Recursion | `@pact-protocols.md` | `@pact-protocols.md` (unchanged â€” stays in index) |
| `pact-backend-coder.md` | Cross-Agent Coordination | `@pact-protocols.md` | `@phase-guidance.md` |
| `pact-backend-coder.md` | S1 Autonomy & Recursion | `@pact-protocols.md` | `@pact-protocols.md` (unchanged) |
| `pact-frontend-coder.md` | Cross-Agent Coordination | `@pact-protocols.md` | `@phase-guidance.md` |
| `pact-frontend-coder.md` | S1 Autonomy & Recursion | `@pact-protocols.md` | `@pact-protocols.md` (unchanged) |
| `pact-database-engineer.md` | Cross-Agent Coordination | `@pact-protocols.md` | `@phase-guidance.md` |
| `pact-database-engineer.md` | S1 Autonomy & Recursion | `@pact-protocols.md` | `@pact-protocols.md` (unchanged) |
| `pact-test-engineer.md` | Cross-Agent Coordination | `@pact-protocols.md` | `@phase-guidance.md` |
| `pact-test-engineer.md` | S1 Autonomy & Recursion | `@pact-protocols.md` | `@pact-protocols.md` (unchanged) |
| `pact-preparer.md` | Cross-Agent Coordination | `@pact-protocols.md` | `@phase-guidance.md` |
| `pact-preparer.md` | S1 Autonomy & Recursion | `@pact-protocols.md` | `@pact-protocols.md` (unchanged) |
| `pact-preparer.md` | S4 Environment Model | `@pact-protocols.md` | `@s4-checkpoints.md` |
| `pact-n8n.md` | Cross-Agent Coordination | `@pact-protocols.md` | `@phase-guidance.md` |
| `pact-n8n.md` | S1 Autonomy & Recursion | `@pact-protocols.md` | `@pact-protocols.md` (unchanged) |

**Summary**:
- 7 refs need updating to `@phase-guidance.md` (Cross-Agent Coordination)
- 7 refs remain as `@pact-protocols.md` (S1 Autonomy stays in lean index)
- 1 ref needs updating to `@s4-checkpoints.md` (pact-preparer's Environment Model ref)
- All `@algedonic.md` refs: No change needed (already separate file)

**Total agent file cross-references requiring updates**: 8 (7 to phase-guidance + 1 to s4-checkpoints)

**Grand total cross-references requiring updates**: 15 (7 internal + 8 agent files)

#### Files to Create

| File | Content Source | Est. Lines |
|------|----------------|------------|
| `.claude/protocols/delegation.md` | pact-protocols.md lines 13-145 | ~145 |
| `.claude/protocols/s4-checkpoints.md` | pact-protocols.md lines 148-291 | ~140 |
| `.claude/protocols/variety-management.md` | pact-protocols.md lines 647-706 | ~60 |
| `.claude/protocols/s2-coordination.md` | pact-protocols.md lines 359-465 | ~110 |
| `.claude/protocols/s3-audit.md` | pact-protocols.md lines 543-601 | ~60 |
| `.claude/protocols/s3s4-tension.md` | pact-protocols.md lines 294-356 | ~65 |
| `.claude/protocols/workflow-protocols.md` | pact-protocols.md lines 721-832 | ~105 |
| `.claude/protocols/phase-guidance.md` | pact-protocols.md lines 835-941 | ~100 |

#### Files to Modify

| File | Changes |
|------|---------|
| `CLAUDE.md` | Compress from 306 â†’ ~100-110 lines (preserve phase principles) |
| `.claude/protocols/pact-protocols.md` | Reduce to ~180-line lean index |
| `.claude/commands/PACT/orchestrate.md` | Replace single @pact-protocols with targeted @-refs |
| `.claude/commands/PACT/plan-mode.md` | Replace @pact-protocols with @variety-management, @workflow-protocols |
| `.claude/commands/PACT/imPACT.md` | Add @workflow-protocols reference |
| `.claude/agents/pact-architect.md` | Update Cross-Agent Coordination ref â†’ @phase-guidance.md |
| `.claude/agents/pact-backend-coder.md` | Update Cross-Agent Coordination ref â†’ @phase-guidance.md |
| `.claude/agents/pact-frontend-coder.md` | Update Cross-Agent Coordination ref â†’ @phase-guidance.md |
| `.claude/agents/pact-database-engineer.md` | Update Cross-Agent Coordination ref â†’ @phase-guidance.md |
| `.claude/agents/pact-test-engineer.md` | Update Cross-Agent Coordination ref â†’ @phase-guidance.md |
| `.claude/agents/pact-preparer.md` | Update Cross-Agent Coordination ref â†’ @phase-guidance.md, S4 Environment Model ref â†’ @s4-checkpoints.md |
| `.claude/agents/pact-n8n.md` | Update Cross-Agent Coordination ref â†’ @phase-guidance.md |
| `pact-plugin/protocols/` | Mirror partitioned files for plugin distribution |
| `pact-plugin/agents/` | Mirror agent file updates for plugin distribution |

#### Protocol File Structure

Each partitioned protocol file follows this structure:

```markdown
# {Protocol Name}

> **Purpose**: One-line description
> **Used by**: List of commands that @-reference this file
> **See also**: Related protocol files (with @-refs)

---

## {Content sections extracted from pact-protocols.md}

...
```

#### CLAUDE.md Proposed Structure (~100-110 lines)

```markdown
# MISSION (7 lines)
Mission statement, motto, VSM note

## S5 POLICY (18 lines)
Non-negotiables table (4 rows), policy checkpoints summary (6 lines)
â†’ "See @~/.claude/protocols/delegation.md for enforcement details"
â†’ "See @~/.claude/protocols/algedonic.md for emergency bypass"

## INSTRUCTIONS (6 lines)
Core directives (read CLAUDE.md, apply PACT, delegate, update)

## GUIDELINES (15 lines)
Context management, git workflow, S3/S4 modes (brief)
â†’ "See @~/.claude/protocols/s3s4-tension.md for tension resolution"

## PACT PHASES (20 lines)
Phase names with 2-3 key principles each (preserved from current)
â†’ PREPARE: Documentation First, Context Gathering, Dependency Mapping
â†’ ARCHITECT: Single Responsibility, Loose Coupling, Interface Segregation
â†’ CODE: Clean Code, DRY, KISS, Error Handling, Security Mindset
â†’ TEST: Coverage, Edge Cases, Integration, Regression Prevention

## SPECIALIST AGENTS (10 lines)
Agent list with emoji identifiers

## ORCHESTRATION COMMANDS (15 lines)
Command list with one-line descriptions
â†’ "See @~/.claude/protocols/variety-management.md for workflow selection"
â†’ "See @~/.claude/protocols/workflow-protocols.md for protocol details"

## DOCUMENTATION LOCATIONS (8 lines)
Phase â†’ Output Location table (condensed)

## PROTOCOL REFERENCE (12 lines)
Quick index of partitioned protocol files with trigger phrases:
- delegation.md â†’ "Before Edit/Write on any file"
- s4-checkpoints.md â†’ "At phase boundaries"
- variety-management.md â†’ "Task assessment, workflow selection"
- s2-coordination.md â†’ "Before parallel agent invocation"
- s3-audit.md â†’ "During CODE phase for quality signals"
- s3s4-tension.md â†’ "When detecting operational vs strategic conflict"
- workflow-protocols.md â†’ "For plan-mode, imPACT, comPACT details"
- phase-guidance.md â†’ "For handoffs, test engagement, boundaries"
- algedonic.md â†’ "Emergency escalation to user"
```

#### pact-protocols.md New Structure (~180 lines)

```markdown
# PACT Protocols (Lean Index)

> **Purpose**: Central index for PACT protocol documentation.
> **Note**: Protocol content has been partitioned into focused files for targeted loading.

## Protocol Files

| Protocol | File | Trigger |
|----------|------|---------|
| Delegation Enforcement | @delegation.md | Before Edit/Write on app code |
| S4 Checkpoints | @s4-checkpoints.md | At phase boundaries |
| Variety Management | @variety-management.md | Task assessment, workflow selection |
| S2 Coordination | @s2-coordination.md | Parallel agent coordination |
| S3* Audit | @s3-audit.md | CODE phase quality signals |
| S3/S4 Tension | @s3s4-tension.md | Mode conflict resolution |
| Workflow Protocols | @workflow-protocols.md | plan-mode, imPACT, comPACT |
| Phase Guidance | @phase-guidance.md | Handoffs, test engagement |
| Algedonic Signals | @algedonic.md | Emergency escalation |

## S1 Autonomy Charter (~72 lines)
[Keep inline - referenced by multiple protocols]

## PACT Workflow Family (~9 lines)
[Keep inline - overview table]

## Cross-Cutting Concerns (~9 lines)
[Keep inline - brief checklist]

## Architecture Review (~6 lines)
[Keep inline - brief]

## Documentation Locations (~70 lines, condensed from ~102)
[Keep inline - reference table, compressed]

## Session Continuity (~6 lines)
[Keep inline]

## Related (~4 lines)
[Keep inline]
```

#### Implementation Sequence

1. `feat(protocols): create delegation.md from pact-protocols.md` â€” Extract S5 Policy Layer
2. `feat(protocols): create s4-checkpoints.md from pact-protocols.md` â€” Extract S4 content + Environment Model
3. `feat(protocols): create variety-management.md from pact-protocols.md` â€” Extract variety content
4. `feat(protocols): create s2-coordination.md from pact-protocols.md` â€” Extract S2 content
5. `feat(protocols): create s3-audit.md from pact-protocols.md` â€” Extract S3* content
6. `feat(protocols): create s3s4-tension.md from pact-protocols.md` â€” Extract tension content
7. `feat(protocols): create workflow-protocols.md from pact-protocols.md` â€” Extract plan-mode, imPACT, comPACT
8. `feat(protocols): create phase-guidance.md from pact-protocols.md` â€” Extract handoffs, test engagement, boundaries
9. `refactor(protocols): convert pact-protocols.md to lean index (~180 lines)` â€” Update internal cross-refs
10. `refactor(claude): compress CLAUDE.md to ~100-110 lines` â€” Preserve phase principles
11. `refactor(commands): update orchestrate.md with targeted @-refs` â€” Replace monolithic ref
12. `refactor(commands): update plan-mode.md with targeted @-refs` â€” Replace monolithic ref
13. `refactor(commands): update imPACT.md with @workflow-protocols` â€” Add protocol ref
14. `refactor(agents): update all 7 agent files with targeted @-refs` â€” Update Cross-Agent Coordination + S4 Environment Model refs
15. `chore(plugin): sync partitioned protocols and agents to pact-plugin/` â€” Mirror for distribution

---

### ðŸ§ª Test Phase
**Effort**: Medium-High (5-6 hours manual validation)

#### Test Scenarios

| Scenario | Type | Priority |
|----------|------|----------|
| Content preservation verification (checklist) | Verification | P0 |
| Cross-reference resolution (all 15 refs: 7 internal + 8 agent) | Verification | P0 |
| Agent file @-ref resolution (all 7 agent files load correct protocols) | Verification | P0 |
| `/PACT:orchestrate` loads correct protocols at each phase | Integration | P0 |
| Delegation enforcement on app code edit | Functional | P0 |
| Algedonic HALT signal bypasses to user | Functional | P0 |
| Tool Checkpoint Protocol fires before Edit/Write | Functional | P0 |
| `/PACT:plan-mode` loads variety-management, workflow-protocols | Integration | P0 |
| `/PACT:imPACT` loads algedonic, workflow-protocols | Integration | P1 |
| S3/S4 tension protocol accessible via targeted @-ref | Functional | P1 |
| S4 checkpoint protocol accessible at phase boundaries | Functional | P1 |
| `/PACT:comPACT` works with optional workflow-protocols ref | Integration | P2 |
| `/PACT:rePACT` works without protocol refs | Integration | P2 |
| Plugin sync matches .claude/ structure | Verification | P2 |

#### Coverage Targets
- Critical path (P0): 100% â€” Must pass for merge
- Core workflows (P1): 100% â€” Should pass for merge
- Edge cases (P2): Best effort â€” May defer

#### Content Preservation Verification

Create `docs/testing/partition-verification.md` during implementation:

```markdown
# Protocol Partitioning Verification Checklist

## Section Coverage
| Original Section | Destination File | Lines | Verified |
|------------------|------------------|-------|----------|
| S5 Policy Layer | delegation.md | 13-145 | [ ] |
| S4 Checkpoint Protocol | s4-checkpoints.md | 148-217 | [ ] |
| ... (all sections from Content Accounting table) |

## Content Integrity
- [ ] Every H2 section from original has corresponding location
- [ ] Every code example preserved
- [ ] Every table preserved
- [ ] All @-references updated or preserved correctly

## Cross-Reference Resolution
| Ref # | Original | Updated To | Verified |
|-------|----------|------------|----------|
| 1 | "see Variety Management" | @variety-management.md | [ ] |
| 2 | S3/S4 refs S4 Checkpoints | @s4-checkpoints.md | [ ] |
| ... (all 7 cross-references) |

## Summary
- Sections verified: X of Y
- Cross-refs verified: X of 7
- Content gaps: [none / list]
```

#### Validation Approach

**Tier 1: Static Verification (1 hour)**
- File existence checks (8 new files)
- Line count validation (sum â‰¥ original)
- @-reference resolution (verify all 7 updated refs work)
- Section heading mapping (checklist)

**Tier 2: Behavioral Verification (2.5-3 hours)**
- Execute `/PACT:orchestrate` on sample task
- Execute `/PACT:plan-mode` on sample task
- Test delegation enforcement (attempt Edit on .ts file)
- Test algedonic escalation (simulate HALT condition)
- Verify protocol content appears in agent responses

**Tier 3: Regression Verification (1.5-2 hours)**
- Compare pre/post behavior on sample tasks
- Verify edge cases still work
- Plugin sync validation (`diff -rq .claude/protocols pact-plugin/protocols`)

#### Regression Baseline

Before implementation, capture:
- [ ] Output of `/PACT:orchestrate` on "add pagination endpoint" task
- [ ] Output of `/PACT:plan-mode` on "implement user auth" task
- [ ] Delegation enforcement behavior (attempt to edit app code)
- [ ] Decision log format produced by CODE phase

After implementation, compare and document any differences.

#### Acceptance Criteria

- [ ] All 8 new protocol files exist and are syntactically valid
- [ ] pact-protocols.md reduced to 150-200 lines (lean index)
- [ ] Compressed CLAUDE.md is 95-115 lines
- [ ] Compressed CLAUDE.md contains phase principles (PREPARE, ARCHITECT, CODE, TEST)
- [ ] Compressed CLAUDE.md contains SACROSANCT policy table
- [ ] Compressed CLAUDE.md contains delegation enforcement summary
- [ ] All 15 cross-references updated correctly (7 internal + 8 agent file refs)
- [ ] All 7 agent files updated with correct targeted @-refs
- [ ] `/PACT:orchestrate` executes without errors
- [ ] `/PACT:plan-mode` executes without errors
- [ ] Tool Checkpoint Protocol triggers on application code
- [ ] Algedonic HALT scenario escalates to user
- [ ] Content preservation checklist: 100% sections verified
- [ ] Plugin sync: `diff` shows only expected differences (protocols and agents)

---

## Rollback Strategy

### Rollback Triggers
- Any P0 test fails after implementation
- More than 2 P1 tests fail
- Critical user-reported issues within 48 hours of merge
- Content preservation checklist shows gaps

### Rollback Procedures

| Stage | Action |
|-------|--------|
| **Before merge** | Abandon PR, no rollback needed |
| **After merge, before release** | `git revert <merge-commit>` |
| **After plugin distribution** | 1) Revert in repo, 2) Publish corrected pact-plugin, 3) Communicate if impact significant |

### Rollback Verification
After rollback:
- [ ] `pact-protocols.md` is original 1,085 lines
- [ ] `CLAUDE.md` is original 306 lines
- [ ] All 7 agent files restored to original @pact-protocols.md refs
- [ ] No orphaned protocol files in .claude/protocols/
- [ ] Plugin sync reverted (protocols and agents)

---

## Synthesized Implementation Roadmap

### Phase Sequence

```
Phase 1: Create Protocol Files (Low Risk)
â”œâ”€â”€ delegation.md
â”œâ”€â”€ s4-checkpoints.md
â”œâ”€â”€ variety-management.md
â”œâ”€â”€ s2-coordination.md
â”œâ”€â”€ s3-audit.md
â”œâ”€â”€ s3s4-tension.md
â”œâ”€â”€ workflow-protocols.md
â””â”€â”€ phase-guidance.md
         â”‚
         â–¼ CHECKPOINT: Verify content extraction complete (checklist)
         â”‚
Phase 2: Update pact-protocols.md (Low Risk)
â”œâ”€â”€ Convert to ~180-line lean index
â””â”€â”€ Update all 7 cross-references
         â”‚
         â–¼ CHECKPOINT: Verify index references resolve correctly
         â”‚
Phase 3: Compress CLAUDE.md (Medium Risk)
â”œâ”€â”€ Restructure to ~100-110 lines
â”œâ”€â”€ Preserve phase principles
â””â”€â”€ Add protocol reference guide with trigger phrases
         â”‚
         â–¼ CHECKPOINT: Run full P0 test suite
         â”‚
Phase 4: Update Commands (Medium Risk)
â”œâ”€â”€ orchestrate.md (targeted @-refs)
â”œâ”€â”€ plan-mode.md (targeted @-refs)
â””â”€â”€ imPACT.md (add @workflow-protocols)
         â”‚
         â–¼ CHECKPOINT: Command validation
         â”‚
Phase 5: Update Agent Files (Low Risk)
â”œâ”€â”€ All 7 agent files: Cross-Agent Coordination â†’ @phase-guidance.md
â””â”€â”€ pact-preparer.md: S4 Environment Model â†’ @s4-checkpoints.md
         â”‚
         â–¼ CHECKPOINT: Agent file @-ref validation + regression comparison
         â”‚
Phase 6: Plugin Sync (Low Risk)
â”œâ”€â”€ Mirror protocols to pact-plugin/protocols/
â””â”€â”€ Mirror agent updates to pact-plugin/agents/
         â”‚
         â–¼ Final PR review
```

### Commit Sequence (Proposed)

1. `feat(protocols): partition S5 policy layer into delegation.md`
2. `feat(protocols): partition S4 checkpoint protocol into s4-checkpoints.md`
3. `feat(protocols): partition variety management into variety-management.md`
4. `feat(protocols): partition S2 coordination into s2-coordination.md`
5. `feat(protocols): partition S3* audit into s3-audit.md`
6. `feat(protocols): partition S3/S4 tension into s3s4-tension.md`
7. `feat(protocols): partition workflow protocols (plan-mode, imPACT, comPACT)`
8. `feat(protocols): partition phase guidance (handoffs, test engagement)`
9. `refactor(protocols): convert pact-protocols.md to lean index`
10. `refactor(claude): compress CLAUDE.md to ~100-110 lines`
11. `refactor(commands): update orchestrate.md with targeted protocol refs`
12. `refactor(commands): update plan-mode.md with targeted protocol refs`
13. `refactor(commands): update imPACT.md with workflow-protocols ref`
14. `refactor(agents): update all 7 agent files with targeted @-refs`
15. `chore(plugin): sync partitioned protocols and agents to pact-plugin/`

---

## Cross-Cutting Concerns

| Concern | Status | Notes |
|---------|--------|-------|
| Security | âœ… Ready | Delegation enforcement and algedonic signals preserved |
| Performance | âœ… Focus | ~55% context reduction for heavy commands |
| Predictability | âœ… Improved | Deterministic @-refs vs skill auto-discovery |
| Maintainability | âœ… Improved | Smaller, focused files easier to update |
| Rollback Safety | âœ… Added | Explicit rollback triggers and procedures |

---

## Open Questions

### Require User Decision

None â€” approach validated through discussion and peer review.

### Require Further Research

- [ ] **Documentation Locations section**: Currently ~102 lines; can be compressed to ~70 lines during implementation
- [ ] **Optimal protocol granularity**: 8 files proposed; may consolidate if testing reveals unnecessary splits

---

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Content lost in partitioning | Low | High | Content accounting table + verification checklist |
| Cross-references break | Low (was Medium) | Medium | Cross-reference inventory with explicit mapping |
| Commands miss needed protocols | Low | Medium | Protocol file mapping table |
| Plugin sync drift | Low | Medium | Mirror protocols in same PR; diff verification |
| CLAUDE.md too compressed | Low (was Medium) | Medium | Revised target ~100-110 lines; phase principles preserved |
| Regression in behavior | Low | Medium | Baseline capture + post-implementation comparison |

---

## Scope Assessment

- **Overall Complexity**: Medium (Variety Score: 8)
- **Estimated Files**: 8 new protocol files, 12 modified files (5 original + 7 agent files)
- **Specialists Required**: None (AI tooling â€” orchestrator may implement directly)
- **External Dependencies**: No â€” internal refactoring only
- **Estimated Time**: 6-7 hours implementation + 5-6 hours validation

---

## PACT Framework Coverage

This plan addresses context management across the **entire PACT framework**.

### Complete Command Inventory

| Command | Lines | Current @-Protocol Load | New @-Protocol Load | Plan Action |
|---------|-------|-------------------------|---------------------|-------------|
| **orchestrate.md** | 480 | ~1,320 lines | ~715 lines | âœ… Targeted @-refs |
| **plan-mode.md** | 441 | ~1,085 lines | ~165 lines | âœ… Targeted @-refs |
| **imPACT.md** | ~100 | ~235 lines | ~340 lines | âœ… Add workflow-protocols |
| **rePACT.md** | 250 | 0 | 0 | âšª No changes needed (verified) |
| **comPACT.md** | 190 | 0 | ~105 (optional) | âšª Optional workflow-protocols ref |
| **peer-review.md** | 27 | 0 | 0 | âšª No changes needed |
| **wrap-up.md** | 35 | 0 | 0 | âšª No changes needed |
| **log-changes.md** | 27 | 0 | 0 | âšª No changes needed |

### rePACT Dependency Verification

**Finding**: `rePACT.md` contains conceptual references to protocols ("Apply S2 coordination", "see Autonomy Charter") but these are **inline explanatory text**, not @-file references. The command is self-contained with its protocol details inline. **No changes needed** â€” verified correct.

### Agent Files Audit

**Finding**: Grep search of `.claude/agents/` for `@.*pact-protocols|@.*protocols/` returned **21 matches across 7 agent files**. Each agent references `pact-protocols.md` for Cross-Agent Coordination and S1 Autonomy rules. Additionally, `pact-preparer.md` references the S4 Environment Model. **8 cross-references require updates** (7 to @phase-guidance.md, 1 to @s4-checkpoints.md). See "Agent Files Cross-Reference Inventory" section for full mapping.

### Universal Benefit: CLAUDE.md Compression

| Entry Point | Current CLAUDE.md | After Compression | Savings |
|-------------|-------------------|-------------------|---------|
| All commands | 306 lines (~4K tokens) | ~100-110 lines (~1.3K tokens) | **67%** |

### Per-Command Context Load (Before/After)

| Command | Current Total | After Plan | Reduction |
|---------|---------------|------------|-----------|
| **orchestrate** | ~2,100 lines | ~1,300 lines | **38%** |
| **plan-mode** | ~1,830 lines | ~720 lines | **61%** |
| **imPACT** | ~640 lines | ~555 lines | **13%** |
| **comPACT** | ~496 lines | ~315 lines | **36%** |
| **rePACT** | ~556 lines | ~360 lines | **35%** |
| **peer-review** | ~333 lines | ~137 lines | **59%** |
| **wrap-up** | ~341 lines | ~145 lines | **57%** |
| **log-changes** | ~333 lines | ~137 lines | **59%** |

*Note: Totals include CLAUDE.md + command file + @-referenced protocol files.*

---

## Token Savings Analysis

| Scenario | Current Load | After Refactor | Savings |
|----------|--------------|----------------|---------|
| Session start (CLAUDE.md) | ~4K | ~1.3K | 67% |
| /PACT:orchestrate invocation | ~15K | ~8K | 47% |
| /PACT:plan-mode invocation | ~12K | ~3K | 75% |
| /PACT:comPACT invocation | ~2K | ~1.5K | 25% |
| Typical full orchestration | ~45K | ~22K | **51%** |

---

## Comparison: Protocol Partitioning vs Skills

| Aspect | Skills (Superseded Plan) | Protocol Partitioning (This Plan) |
|--------|--------------------------|-----------------------------------|
| **Loading behavior** | Claude decides when to load | Deterministic, controlled |
| **Predictability** | Variable (auto-discovery) | Consistent (explicit @-refs) |
| **Fit for PACT** | Suboptimal (PACT is structured) | Optimal (matches PACT's determinism) |
| **Implementation** | New skill files + frontmatter | Partition existing content |
| **Risk** | False positive/negative loading | None (explicit control) |
| **Estimated savings** | ~73% | ~51% |

**Trade-off**: Protocol partitioning sacrifices ~22% potential savings for predictability, verifiability, and alignment with PACT's structured workflow nature.

---

## Related Context

- **Issue**: #64 - Context Architecture Review
- **Supersedes**: PR #68 draft plan, `context-architecture-skills-plan.md`
- **Research Basis**: [Anthropic Context Engineering Guide](https://www.anthropic.com/research/building-effective-agents), PACT workflow analysis
- **Peer Review**: Incorporated feedback from pact-architect, pact-preparer, pact-test-engineer (2026-01-15)

---

## Next Steps

After approval:
```
/PACT:orchestrate implement protocol partitioning context architecture optimization per approved plan
```

The orchestrator will reference this plan during execution. Since this is AI tooling (not application code), the orchestrator may implement changes directly without delegating to specialist coders.
